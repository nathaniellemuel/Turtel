<?php
// Temporary: show all PHP errors in browser to diagnose blank white screen
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
// Follow the same include approach as your `index.php`: require the controller which
// in turn requires Connection.php and defines $conn and BASE_URL.
require_once __DIR__ . '/../../../Connection/Connection.php';
require_once __DIR__ . '/../../../Controller/UserController.php';
require_once __DIR__ . '/../../../Controller/LaporanController.php';
require_once __DIR__ . '/../../../Controller/TugasController.php';
require_once __DIR__ . '/../../../Controller/KandangController.php';
require_once __DIR__ . '/../../../Controller/StokController.php';
require_once __DIR__ . '/../../../Controller/PakanController.php';

session_start();

// Simple access control: only allow admin to view admin dashboard
if (!isset($_SESSION['role']) || $_SESSION['role'] !== 'admin') {
	header('Location: ' . (defined('BASE_URL') ? BASE_URL . '/View/pages/auth/index.php' : '/Turtel/View/pages/auth/index.php'));
	exit;
}

// Instantiate controllers (they expect $conn)
$userCtrl = new UserController($conn);
$laporanCtrl = new LaporanController($conn);
$tugasCtrl = new TugasController($conn);
$kandangCtrl = new KandangController($conn);
$stokCtrl = new StokController($conn);
$pakanCtrl = new PakanController($conn);

// Simple router for sections via ?section=
$section = $_GET['section'] ?? 'laporan';

// Handle form submissions
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
	$action = $_POST['action'] ?? '';

	// Users (add staff)
	if ($action === 'add_user') {
		$username = $_POST['username'] ?? '';
		$email = $_POST['email'] ?? '';
		$password = $_POST['password'] ?? '';
		$res = $userCtrl->register($username, $email, $password, 'staff', 'aktif');
		$flash = $res['message'] ?? 'Done';
		$section = 'users';
	}

	// Update profile (admin)
	if ($action === 'update_profile') {
		$userId = $_SESSION['user_id'] ?? null;
		$newUsername = $_POST['username'] ?? '';
		$oldPassword = $_POST['old_password'] ?? null;
		$newPassword = $_POST['new_password'] ?? null;
		if ($userId) {
			$res = $userCtrl->updateProfile($userId, $newUsername, $oldPassword ?: null, $newPassword ?: null);
			$flash = $res['message'] ?? 'Updated';
		} else {
			$flash = 'User not logged in';
		}
		$section = 'profile';
	}

	// Tugas CRUD
	if ($action === 'add_tugas') {
		$created_at = $_POST['created_at'] ?: date('Y-m-d H:i:s');
		$deskripsi = $_POST['deskripsi'] ?? '';
		$status = $_POST['status'] ?? 'pending';
		$id_user = $_POST['id_user'] ?: null;
		$id_pakan = $_POST['id_pakan'] ?: null;
		$res = $tugasCtrl->create($created_at, $deskripsi, $status, $id_user, $id_pakan);
		$flash = $res['message'] ?? '';
		$section = 'tugas';
	}
	if ($action === 'delete_tugas') {
		$id = intval($_POST['id_tugas'] ?? 0);
		$res = $tugasCtrl->delete($id);
		$flash = $res['message'] ?? '';
		$section = 'tugas';
	}

		// set status quick action
		if ($action === 'set_status_tugas') {
			$id = intval($_POST['id_tugas'] ?? 0);
			$status = $_POST['status'] ?? 'selesai';
			$res = $tugasCtrl->setStatus($id, $status);
			$flash = $res['message'] ?? '';
			$section = 'tugas';
		}

	// Kandang CRUD
	if ($action === 'add_kandang') {
		$nama = $_POST['nama_kandang'] ?? '';
		$jenis = $_POST['jenis_ayam'] ?? 'negeri';
		$jumlah = intval($_POST['jumlah_ayam'] ?? 0);
		$created_at = $_POST['created_at'] ?: date('Y-m-d H:i:s');
		$id_telur = isset($_POST['id_telur']) && $_POST['id_telur'] !== '' ? intval($_POST['id_telur']) : null;
		$res = $kandangCtrl->create($nama, $jenis, $jumlah, $created_at, $id_telur);
		$flash = $res['message'] ?? '';
		$section = 'kandang';
	}
	if ($action === 'delete_kandang') {
		$id = intval($_POST['id_kandang'] ?? 0);
		$res = $kandangCtrl->delete($id);
		$flash = $res['message'] ?? '';
		$section = 'kandang';
	}

	// Stok CRUD
	if ($action === 'add_stok') {
		$kategori = $_POST['kategori'] ?? 'pakan';
		$nama = $_POST['nama_stock'] ?? '';
		$jumlah = intval($_POST['jumlah'] ?? 0);
		$res = $stokCtrl->create($kategori, $nama, $jumlah);
		$flash = $res['message'] ?? '';
		$section = 'stok';
	}
	if ($action === 'delete_stok') {
		$id = intval($_POST['id_stock'] ?? 0);
		$res = $stokCtrl->delete($id);
		$flash = $res['message'] ?? '';
		$section = 'stok';
	}

	// Pakan CRUD
	if ($action === 'add_pakan') {
		$jumlah_digunakan = intval($_POST['jumlah_digunakan'] ?? 0);
		$created_at = $_POST['created_at'] ?: date('Y-m-d H:i:s');
		$id_stock = isset($_POST['id_stock']) && $_POST['id_stock'] !== '' ? intval($_POST['id_stock']) : null;
		
		// Validasi: cek stok tersedia sebelum insert pakan
		if ($id_stock) {
			$stokData = $stokCtrl->getById($id_stock);
			if ($stokData['success']) {
				$currentJumlah = intval($stokData['data']['jumlah']);
				if ($currentJumlah <= 0) {
					$flash = 'Gagal menambah pakan: Stok habis (0). Silakan tambah stok terlebih dahulu.';
					$section = 'pakan';
				} elseif ($jumlah_digunakan > $currentJumlah) {
					$flash = "Gagal menambah pakan: Jumlah diminta ($jumlah_digunakan) melebihi stok tersedia ($currentJumlah).";
					$section = 'pakan';
				} else {
					// Stok cukup, lanjutkan insert dan kurangi stok
					$res = $pakanCtrl->create($jumlah_digunakan, $created_at, $id_stock);
					if ($res['success']) {
						$newJumlah = $currentJumlah - $jumlah_digunakan;
						$stokCtrl->update($id_stock, $stokData['data']['kategori'], $stokData['data']['nama_stock'], $newJumlah);
					}
					$flash = $res['message'] ?? '';
					$section = 'pakan';
				}
			} else {
				$flash = 'Stok tidak ditemukan';
				$section = 'pakan';
			}
		} else {
			// Tidak ada id_stock, insert tanpa validasi stok
			$res = $pakanCtrl->create($jumlah_digunakan, $created_at, $id_stock);
			$flash = $res['message'] ?? '';
			$section = 'pakan';
		}
	}
	if ($action === 'delete_pakan') {
		$id = intval($_POST['id_pakan'] ?? 0);
		$res = $pakanCtrl->delete($id);
		$flash = $res['message'] ?? '';
		$section = 'pakan';
	}

}

// Fetch data for views
$laporans = $laporanCtrl->getAll()['data'] ?? [];
$usersRes = $conn->query('SELECT id_user, username, email, role, status FROM user ORDER BY id_user DESC');
$usersArr = [];
if ($usersRes) {
	while ($r = $usersRes->fetch_assoc()) {
		$usersArr[] = $r;
	}
}
$tugass = $tugasCtrl->getAll()['data'] ?? [];
$kandangs = $kandangCtrl->getAll()['data'] ?? [];
$stoks = $stokCtrl->getAll()['data'] ?? [];
$pakans = $pakanCtrl->getAll()['data'] ?? [];

// Query untuk laporan telur per kandang dari tabel kandang + telur
$laporanTelurQuery = "SELECT k.id_kandang, k.nama_kandang, k.jenis_ayam, k.jumlah_ayam, 
                      t.jumlah_telur, t.berat, t.layed_at
                      FROM kandang k
                      LEFT JOIN telur t ON k.id_telur = t.id_telur
                      WHERE k.id_telur IS NOT NULL
                      ORDER BY t.layed_at DESC";
$laporanTelurResult = $conn->query($laporanTelurQuery);
$laporanTelur = [];
if ($laporanTelurResult) {
	while ($row = $laporanTelurResult->fetch_assoc()) {
		$laporanTelur[] = $row;
	}
}

?>
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Admin Dashboard - Testing DB</title>
	<link rel="stylesheet" href="<?= BASE_URL ?>/View/Assets/css/bootstrap.min.css">
	<style>
		.nav-section { margin-top: 1rem; }
		.flash { margin-top: 1rem; }
	</style>
</head>
<body>
<div class="container mt-4">
	<div class="d-flex justify-content-between align-items-center">
		<h2>Admin Dashboard - DB Tester</h2>
		<div>
			<span class="me-3">Logged as: <?= htmlspecialchars($_SESSION['username'] ?? 'Admin') ?></span>
			<a href="<?= BASE_URL ?>/Controller/Logout.php" class="btn btn-sm btn-outline-secondary">Logout</a>
		</div>
